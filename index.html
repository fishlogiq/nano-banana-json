<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shopify Tools: Image Prompt & Descriptions</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;--primary:#667eea;--success:#10b981;--muted:#6b7280}
    body{margin:0;padding:24px;max-width:1200px;margin:0 auto;background:#f9fafb}
    header{margin-bottom:24px;text-align:center;padding:28px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:16px}
    header h1{margin:0 0 6px 0}
    .tabs{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .tab-btn{background:#ffffff22;color:#fff;border:1px solid #ffffff55;padding:10px 16px;border-radius:999px;cursor:pointer;font-weight:600}
    .tab-btn[aria-selected="true"]{background:#fff;color:#374151}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    h2{margin:0 0 12px 0;color:#1f2937;font-size:20px;border-bottom:2px solid #e5e7eb;padding-bottom:10px}
    .input-group{margin-bottom:16px}
    .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#374151}
    .input-group input,.input-group select,.input-group textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#fff}
    .input-group input:focus,.input-group select:focus,.input-group textarea:focus{outline:none;border-color:var(--primary)}
    .form-row-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.form-row-2{grid-template-columns:1fr}}
    .btn-group{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    button{padding:12px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .loader{display:none;width:20px;height:20px;border:3px solid #f3f4f6;border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .help-text{font-size:13px;color:var(--muted);margin-top:4px}
    textarea.code{min-height:360px;font-family:ui-monospace,Menlo,Consolas,monospace;background:#111827;color:#d1d5db}
    [data-tab]{display:none}.active{display:block}
    .preview{border:1px dashed #e5e7eb;border-radius:12px;padding:16px;background:#fff}
    
    /* Progress Bar Styles */
    .progress-container{display:none;margin:16px 0;background:#e5e7eb;border-radius:8px;overflow:hidden;height:8px;position:relative}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),#764ba2);width:0%;transition:width 0.3s ease;border-radius:8px}
    .progress-text{text-align:center;margin-top:8px;font-size:14px;color:var(--muted);font-weight:600}
    .progress-container.active{display:block}
    
    @keyframes progressPulse{
      0%{opacity:1}
      50%{opacity:0.6}
      100%{opacity:1}
    }
    .progress-bar.indeterminate{
      width:100%;
      animation:progressPulse 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <header>
    <h1>Shopify Tools</h1>
    <p>Generate AI Image Prompts or Shopify Descriptions from a product URL</p>
    <div class="tabs" role="tablist" aria-label="Tool selector">
      <button class="tab-btn" role="tab" aria-controls="tab-image" aria-selected="true" id="tabbtn-image">Image Prompt</button>
      <button class="tab-btn" role="tab" aria-controls="tab-desc" aria-selected="false" id="tabbtn-desc">Description Generator</button>
    </div>
  </header>

  <main>
    <!-- ================= IMAGE PROMPT ================= -->
    <section class="card active" id="tab-image" data-tab role="tabpanel" aria-labelledby="tabbtn-image">
      <h2>Imagen Prompt from Shopify URL</h2>

      <div class="input-group">
        <label for="shopifyUrl">Shopify Product URL *</label>
        <input id="shopifyUrl" type="url" placeholder="https://yourstore.com/products/product-name" />
        <p class="help-text">Used only for the Image Prompt tab.</p>
      </div>

      <div class="form-row-2">
        <div class="input-group">
          <label for="modelCount">Number of Models</label>
          <select id="modelCount">
            <option value="1">1 Model</option>
            <option value="2" selected>2 Models</option>
          </select>
        </div>
        <div class="input-group">
          <label for="ageCategory">Age Category</label>
          <select id="ageCategory">
            <option value="">Auto-detect</option>
            <option value="18mon">18 Months</option><option value="3t">3 Years</option>
            <option value="7y">7 Years</option><option value="12yr">12 Years</option>
            <option value="18yr">18 Years</option><option value="adult">Adult (25-35)</option>
          </select>
        </div>
      </div>

      <div class="form-row-2">
        <div class="input-group">
          <label for="ethnicity1">Model 1 Ethnicity</label>
          <select id="ethnicity1">
            <option value="Hispanic">Hispanic/Latino</option>
            <option value="African American">African American</option>
            <option value="Caucasian">Caucasian</option>
            <option value="Asian">Asian</option>
            <option value="Mixed">Mixed</option>
          </select>
        </div>
        <div class="input-group">
          <label for="ethnicity2">Model 2 Ethnicity</label>
          <select id="ethnicity2">
            <option value="Hispanic">Hispanic/Latino</option>
            <option value="African American" selected>African American</option>
            <option value="Caucasian">Caucasian</option>
            <option value="Asian">Asian</option>
            <option value="Mixed">Mixed</option>
          </select>
        </div>
      </div>

      <div class="btn-group" style="gap:20px;align-items:center;">
        <label><input type="checkbox" id="showMovement" /> Show Movement</label>
        <label><input type="checkbox" id="addSneakers" /> Sneakers</label>
        <label><input type="checkbox" id="addSocks" /> Socks</label>
        <label><input type="checkbox" id="addShoes" /> Casual Shoes</label>
        <label><input type="checkbox" id="addWorkBoots" /> Work Boots</label>
      </div>

      <div class="btn-group">
        <button id="generateBtn" class="btn-primary">Generate Prompt</button>
        <div class="loader" id="loader"></div>
      </div>
      
      <!-- Progress Bar for Image Prompt -->
      <div class="progress-container" id="imageProgress">
        <div class="progress-bar indeterminate"></div>
      </div>
      <div class="progress-text" id="imageProgressText" style="display:none;">Generating prompt...</div>
      
      <div id="errorMessage" style="display:none;color:#b91c1c;margin-top:10px;"></div>

      <section class="card" id="outputSection" style="display:none;">
        <h2>Generated Prompt</h2>
        <textarea id="jsonOutput" class="code" readonly></textarea>
        <div class="btn-group">
          <button id="copyBtn" class="btn-success">Copy JSON</button>
          <button id="downloadRefBtn" class="btn-primary">Download Reference Image</button>
        </div>
        <div id="successMessage" style="display:none;margin-top:8px;color:#065f46;"></div>
      </section>
    </section>

    <!-- ================= DESCRIPTION ================= -->
    <section class="card" id="tab-desc" data-tab role="tabpanel" aria-labelledby="tabbtn-desc">
      <h2>Shopify Description Generator</h2>

      <div class="input-group">
        <label for="descUrl">Shopify Product URL *</label>
        <input id="descUrl" type="url" placeholder="https://yourstore.com/products/product-name" />
        <p class="help-text">Calls your Cloud Function and returns HTML / Markdown / JSON directly.</p>
      </div>

      <div class="form-row-2">
        <div class="input-group">
          <label for="descFormat">Output</label>
          <select id="descFormat">
            <option value="html" selected>HTML (Shopify)</option>
            <option value="md">Markdown</option>
            <option value="json">JSON</option>
          </select>
        </div>
        <div class="input-group">
          <label style="display:flex;gap:8px;align-items:center;margin-top:28px;">
            <input type="checkbox" id="showPreview" /> Show preview
          </label>
        </div>
      </div>

      <div class="btn-group">
        <button id="genDescBtn" class="btn-primary">Generate Description</button>
        <button id="copyDescBtn" class="btn-success">Copy</button>
      </div>

      <!-- Progress Bar for Description -->
      <div class="progress-container" id="descProgress">
        <div class="progress-bar" id="descProgressBar"></div>
      </div>
      <div class="progress-text" id="descProgressText" style="display:none;"></div>

      <section class="card" id="descOutWrap" style="display:none;">
        <h2>Output</h2>
        <textarea id="descOutput" class="code" readonly></textarea>
        <div id="descPreview" class="preview" style="display:none;margin-top:16px;"></div>
      </section>
      <div id="descMsg" style="display:none;margin-top:8px;color:#065f46;"></div>
    </section>
  </main>

  <!-- Image Prompt JS -->
  <script src="./prompt-generator.js"></script>

  <script>
    // ---------- Tabs ----------
    const tabs = { image: document.getElementById('tab-image'), desc: document.getElementById('tab-desc') };
    const btnImage = document.getElementById('tabbtn-image');
    const btnDesc  = document.getElementById('tabbtn-desc');
    function selectTab(which){
      Object.values(tabs).forEach(el => el.classList.remove('active'));
      tabs[which].classList.add('active');
      btnImage.setAttribute('aria-selected', which==='image');
      btnDesc.setAttribute('aria-selected', which==='desc');
    }
    btnImage.addEventListener('click', () => selectTab('image'));
    btnDesc .addEventListener('click', () => selectTab('desc'));
    selectTab('image');

    // ---------- Description: direct call with progress ----------
    const API_PRODUCT = 'https://shopifyproductgenerator-804118462449.us-central1.run.app';
    const $ = id => document.getElementById(id);
    const genDescBtn = $('genDescBtn'), copyDescBtn = $('copyDescBtn');
    const out = $('descOutput'), outWrap = $('descOutWrap'), msg = $('descMsg');
    const preview = $('descPreview'), showPreview = $('showPreview');
    const descProgress = $('descProgress'), descProgressBar = $('descProgressBar'), descProgressText = $('descProgressText');

    // Progress simulation
    function simulateProgress(progressBar, progressText, steps) {
      let progress = 0;
      const interval = setInterval(() => {
        if (progress < steps.length - 1) {
          progress++;
          const step = steps[progress];
          progressBar.style.width = step.percent + '%';
          progressText.textContent = step.text;
        }
      }, 800);
      return interval;
    }

    // Minimal Markdown -> HTML for preview fallback
    function mdToHtml(md){
      if (!md) return '';
      let h = md.replace(/\r\n/g, '\n');
      h = h.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      h = h.replace(/\*(.+?)\*/g, '<em>$1</em>');
      h = h.replace(/^\s*-\s+(.+)$/gm, '<li>$1</li>');
      h = h.replace(/(<li>[\s\S]*?<\/li>)(?:(?:\n)?(?!<li>))/g, (m)=>`<ul>${m}</ul>`);
      h = h.split(/\n{2,}/).map(p => {
        if (p.startsWith('<ul>')) return p;
        return `<p>${p.replace(/\n/g,' ')}</p>`;
      }).join('\n');
      return h;
    }

    // Normalize API -> consistent fields
    function normalizeApi(outObj){
      const title = outObj.title || outObj.product_title || '';
      const md = outObj.description_markdown || outObj.product_description || '';
      const html = outObj.description_html || mdToHtml(md);

      let seoTitle = outObj.seo_title || '';
      let seoDesc  = outObj.seo_description || outObj.seo_meta_description || '';

      if (!seoTitle && title) {
        seoTitle = title.slice(0, 60);
      }
      if (!seoDesc && md) {
        const plain = md
          .replace(/\*\*(.+?)\*\*/g,'$1')
          .replace(/^\s*-\s+/gm,'')
          .replace(/\n+/g,' ')
          .trim();
        seoDesc = plain.slice(0, 155);
      }

      return { title, md, html, seoTitle, seoDesc };
    }

    genDescBtn.addEventListener('click', async () => {
      const url  = $('descUrl').value.trim();
      const want = $('descFormat').value;
      if (!url || !url.includes('/products/')) { alert('Enter a valid Shopify product URL'); return; }

      // Reset UI
      outWrap.style.display = 'none'; 
      preview.style.display = 'none'; 
      msg.style.display = 'none'; 
      out.value = '';
      genDescBtn.disabled = true;

      // Show progress bar
      descProgress.classList.add('active');
      descProgressText.style.display = 'block';
      descProgressBar.style.width = '0%';
      descProgressBar.classList.remove('indeterminate');

      // Progress steps
      const steps = [
        { percent: 0, text: 'Fetching product data...' },
        { percent: 25, text: 'Analyzing product details...' },
        { percent: 50, text: 'Detecting categories and sizes...' },
        { percent: 75, text: 'Generating AI content with Gemini...' },
        { percent: 95, text: 'Finalizing output...' }
      ];
      
      descProgressText.textContent = steps[0].text;
      const progressInterval = simulateProgress(descProgressBar, descProgressText, steps);

      try {
        const res = await fetch(API_PRODUCT, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ product_url: url })
        });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { throw new Error('Non-JSON response from API'); }

        const apiPayload = data.outputs || data;
        const { title, md, html, seoTitle, seoDesc } = normalizeApi(apiPayload);

        // Create complete output object
        const jsonOut = {
          title,
          seo_title: seoTitle,
          seo_description: seoDesc,
          description_markdown: md,
          description_html: html
        };

        // Format output based on selection
        if (want === 'json') {
          out.value = JSON.stringify(jsonOut, null, 2);
        } else if (want === 'md') {
          out.value = `TITLE:\n${title}\n\nSEO TITLE:\n${seoTitle}\n\nSEO DESCRIPTION:\n${seoDesc}\n\nDESCRIPTION:\n${md}`;
        } else {
          out.value = `<!-- TITLE -->\n${title}\n\n<!-- SEO TITLE -->\n${seoTitle}\n\n<!-- SEO DESCRIPTION -->\n${seoDesc}\n\n<!-- DESCRIPTION HTML -->\n${html}`;
        }

        if (showPreview.checked) {
          preview.innerHTML = `<h3>${title}</h3><p><strong>SEO Title:</strong> ${seoTitle}</p><p><strong>SEO Desc:</strong> ${seoDesc}</p><hr>${html}`;
          preview.style.display = 'block';
        }

        // Complete progress
        clearInterval(progressInterval);
        descProgressBar.style.width = '100%';
        descProgressText.textContent = 'Complete!';

        setTimeout(() => {
          descProgress.classList.remove('active');
          descProgressText.style.display = 'none';
        }, 1000);

        outWrap.style.display = 'block';
        msg.textContent = 'Generated successfully!';
        msg.style.display = 'block';
        msg.style.color = '#065f46';
      } catch (e) {
        clearInterval(progressInterval);
        descProgress.classList.remove('active');
        descProgressText.style.display = 'none';
        
        msg.textContent = 'Error: ' + e.message;
        msg.style.display = 'block';
        msg.style.color = '#b91c1c';
      } finally {
        genDescBtn.disabled = false;
      }
    });

    copyDescBtn.addEventListener('click', async () => {
      if (!out.value) return;
      await navigator.clipboard.writeText(out.value);
      msg.textContent = 'Copied!';
      msg.style.color = '#065f46';
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 1500);
    });
  </script>
</body>
</html>
